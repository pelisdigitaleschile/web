import React, { useState } from 'react';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Calendar } from '@/components/ui/calendar';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { CalendarIcon } from 'lucide-react';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';

const productos = [
  {
    id: 1,
    nombre: 'Hamburguesa Cl√°sica',
    descripcion: 'Hamburguesa de carne con queso y verduras',
    precio: 5990
  },
  {
    id: 2,
    nombre: 'Pizza Margherita',
    descripcion: 'Pizza tradicional con tomate, mozzarella y albahaca',
    precio: 7990
  },
  {
    id: 3,
    nombre: 'Ensalada C√©sar',
    descripcion: 'Ensalada con pollo, croutones y aderezo C√©sar',
    precio: 4990
  }
];

const ReservationForm = () => {
  const [formData, setFormData] = useState({
    fechaHora: null,
    cantidadPersonas: '',
    nombre: '',
    apellidos: '',
    celular: '+569-',
    email: '',
    comentarios: ''
  });

  const [carrito, setCarrito] = useState(
    productos.map(producto => ({
      ...producto, 
      cantidad: 0
    }))
  );

  const handleFormChange = (e) => {
    const { name, value } = e.target;
    
    // Validaci√≥n especial para celular
    if (name === 'celular') {
      // Permitir solo n√∫meros despu√©s del +569-
      const formattedValue = value.replace(/[^\d]/g, '');
      const formattedPhone = formattedValue.length > 0 
        ? `+569-${formattedValue}` 
        : '+569-';
      
      setFormData(prevState => ({
        ...prevState,
        [name]: formattedPhone
      }));
    } else {
      setFormData(prevState => ({
        ...prevState,
        [name]: value
      }));
    }
  };

  const handleCantidadChange = (productoId, cantidad) => {
    setCarrito(prevCarrito => 
      prevCarrito.map(item => 
        item.id === productoId 
          ? { ...item, cantidad: Math.max(0, cantidad) }
          : item
      )
    );
  };

  const calcularSubtotal = (producto) => {
    return producto.precio * producto.cantidad;
  };

  const calcularTotal = () => {
    return carrito.reduce((total, producto) => 
      total + calcularSubtotal(producto), 0
    );
  };

  const generarMensajeWhatsApp = () => {
    let mensaje = "üõí *Formulario de Reserva*\n\n";
    
    // Datos personales
    mensaje += `*Datos Personales:*\n`;
    mensaje += `Fecha y Hora: ${formData.fechaHora ? format(formData.fechaHora, 'PPp', { locale: es }) : 'No seleccionada'}\n`;
    mensaje += `Cantidad de Personas: ${formData.cantidadPersonas}\n`;
    mensaje += `Nombre: ${formData.nombre}\n`;
    mensaje += `Apellidos: ${formData.apellidos}\n`;
    mensaje += `Celular: ${formData.celular}\n`;
    mensaje += `E-mail: ${formData.email}\n`;
    mensaje += `Comentarios: ${formData.comentarios}\n\n`;
    
    // Productos
    mensaje += `*Productos:*\n`;
    carrito.filter(p => p.cantidad > 0).forEach(producto => {
      mensaje += `${producto.nombre} - Cantidad: ${producto.cantidad} - Subtotal: $${calcularSubtotal(producto).toLocaleString('es-CL')}\n`;
    });
    
    mensaje += `\n*Total:* $${calcularTotal().toLocaleString('es-CL')}`;

    // Codificar el mensaje para WhatsApp
    const mensajeEncoded = encodeURIComponent(mensaje);
    const whatsappUrl = `https://wa.me/TUNUMERODEWHATSAPP?text=${mensajeEncoded}`;
    
    window.open(whatsappUrl, '_blank');
  };

  return (
    <div className="max-w-md mx-auto p-4 bg-white shadow-md rounded-lg">
      <h2 className="text-2xl font-bold mb-4">Formulario de Reservas</h2>
      
      {/* Informaci√≥n Personal */}
      <div className="space-y-4">
        <div>
          <Label>Fecha y Hora</Label>
          <Popover>
            <PopoverTrigger asChild>
              <Button
                variant={"outline"}
                className={`w-full justify-start text-left font-normal ${
                  !formData.fechaHora && "text-muted-foreground"
                }`}
              >
                <CalendarIcon className="mr-2 h-4 w-4" />
                {formData.fechaHora ? (
                  format(formData.fechaHora, 'PPp', { locale: es })
                ) : (
                  <span>Selecciona fecha y hora</span>
                )}
              </Button>
            </PopoverTrigger>
            <PopoverContent className="w-auto p-0">
              <Calendar
                mode="single"
                selected={formData.fechaHora}
                onSelect={(date) => setFormData(prev => ({
                  ...prev, 
                  fechaHora: date
                }))}
                locale={es}
                initialFocus
              />
            </PopoverContent>
          </Popover>
        </div>
        <div>
          <Label>Cantidad de Personas</Label>
          <Input 
            type="number" 
            name="cantidadPersonas"
            value={formData.cantidadPersonas}
            onChange={handleFormChange}
            min="1"
          />
        </div>
        <div>
          <Label>Nombre</Label>
          <Input 
            name="nombre"
            value={formData.nombre}
            onChange={handleFormChange}
          />
        </div>
        <div>
          <Label>Apellidos</Label>
          <Input 
            name="apellidos"
            value={formData.apellidos}
            onChange={handleFormChange}
          />
        </div>
        <div>
          <Label>Celular</Label>
          <Input 
            name="celular"
            value={formData.celular}
            onChange={handleFormChange}
            placeholder="+569-12345678"
          />
        </div>
        <div>
          <Label>E-mail</Label>
          <Input 
            type="email" 
            name="email"
            value={formData.email}
            onChange={handleFormChange}
          />
        </div>
        <div>
          <Label>Comentarios</Label>
          <Textarea
            name="comentarios"
            value={formData.comentarios}
            onChange={handleFormChange}
          />
        </div>
      </div>

      {/* Carrito de Productos */}
      <div className="mt-6">
        <h3 className="text-xl font-semibold mb-4">Productos</h3>
        {carrito.map(producto => (
          <div key={producto.id} className="flex items-center mb-4 space-x-4">
            <div className="flex-grow">
              <h4 className="font-medium">{producto.nombre}</h4>
              <p className="text-sm text-gray-500">{producto.descripcion}</p>
              <p className="text-sm">Precio: ${producto.precio.toLocaleString('es-CL')}</p>
            </div>
            <div className="flex items-center space-x-2">
              <Button 
                variant="outline" 
                size="sm"
                onClick={() => handleCantidadChange(producto.id, producto.cantidad - 1)}
              >
                -
              </Button>
              <Input 
                type="number" 
                value={producto.cantidad}
                onChange={(e) => handleCantidadChange(producto.id, parseInt(e.target.value))}
                className="w-16 text-center"
                min="0"
              />
              <Button 
                variant="outline" 
                size="sm"
                onClick={() => handleCantidadChange(producto.id, producto.cantidad + 1)}
              >
                +
              </Button>
            </div>
          </div>
        ))}

        {/* Resumen de Compra */}
        <div className="mt-4 border-t pt-4">
          <div className="flex justify-between">
            <span>Total:</span>
            <span className="font-bold">${calcularTotal().toLocaleString('es-CL')}</span>
          </div>
        </div>
      </div>

      {/* Bot√≥n de Env√≠o */}
      <Button 
        className="w-full mt-6"
        onClick={generarMensajeWhatsApp}
      >
        Enviar por WhatsApp
      </Button>
    </div>
  );
};

export default ReservationForm;